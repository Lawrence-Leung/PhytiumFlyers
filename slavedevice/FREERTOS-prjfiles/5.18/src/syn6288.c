#include "syn6288.h"
#include "uart.h"
#include "string.h"
#include "fpl011_os.h"

#define SYN_FRAME_INFO_SIZE 256 // combination = para + data

extern FtFreertosUart uart;
extern FtFreertosUartConfig uart_config;
//Music:é???????????é????????0:?????????é????????1~15???é???????????é?????
void syn6288UartInit(void)
{
    FtFreertosUartInit(&uart,&uart_config);
    f_printk("[SLAVE] syn6288 ready!!\r\n");

}

void syn6288Play(u8 *data)
{
    char combination[SYN_FRAME_INFO_SIZE];
    char para[12] = "[v1][m0][t5]";

    // ????????????
    size_t remaining_space = SYN_FRAME_INFO_SIZE - strlen(para) - 1; //计算字符串剩余空间(-1防止结束符溢出，可删去)
    size_t data_length = strlen(data);
    // f_printk("[SYN6288]remaining_space:%d\r\n",remaining_space);
    
    // 判断数据长度是否过长
    if (data_length > remaining_space) {
        printf("[SYN6288]Error: Data too long\n");
        return;
    }
    else
    {
        sprintf(combination,"%s%s",para,data);
        SYN_FrameInfo(0,combination);               //播放语音，0：没有背景音乐
    }
        
    f_printk("[SYN6288]syn6288 finished!!\r\n");
}


/*
void SYN_FrameInfo(u8 Music, u8 *HZdata)
Music:bgm
HZdata:data to play
Migrate from STM32,do not change
*/
void SYN_FrameInfo(u8 Music, u8 *HZdata)
{
    /****************é????????é???????????**********************************/
    unsigned  char  Frame_Info[50];
    unsigned  char  HZ_Length;
    unsigned  char  ecc  = 0;  			//?????????é????????
    unsigned  int i = 0;
    HZ_Length = strlen((char*)HZdata); 			//é????????é???????????é?????

    /*****************??§??????é???????????**************************************/
    Frame_Info[0] = 0xFD ; 			//???é????§?¤?FD
    Frame_Info[1] = 0x00 ; 			//???é????°??????é????????é????????
    Frame_Info[2] = HZ_Length + 3; 		//???é????°??????é?????????????????
    Frame_Info[3] = 0x01 ; 			//???é???????¤????????????????????????
    Frame_Info[4] = 0x01 | Music << 4 ; //???é???????¤?????°?????????é???????????

    /*******************???é???????????***************************************/
    for(i = 0; i < 5; i++)   				//?????????é?????é????????5?????§?¤???????
    {
        ecc = ecc ^ (Frame_Info[i]);		//??????é??????????????????????????é??
    }

    for(i = 0; i < HZ_Length; i++)   		//?????????é??????????????????????°???
    {
        ecc = ecc ^ (HZdata[i]); 				//??????é??????????????????????????é??
    }
    /*******************???é????§??????***************************************/
    memcpy(&Frame_Info[5], HZdata, HZ_Length);
    Frame_Info[5 + HZ_Length] = ecc;
    //   USART3_SendString(Frame_Info, 5 + HZ_Length + 1);
    // f_printk("speaking......\r\n");
    FtFreertosUartBlcokingSend(&uart,Frame_Info,5+HZ_Length+1);     //???????????°????????¨??????
    // FPl011Send(&uart.bsp_uart,Frame_Info,5 + HZ_Length + 1);
}


/***********************************************************
* ???    ?§°??? YS_SYN_Set(u8 *Info_data)
* ???    ?????? ?????????	?¨??????????
* ???????????°??? *Info_data:?????????é??????????????é??
* ???????????°???
* ???    ??????????????°??¨???é???????????????????????????????????????????? ???é????¤?????????9600bps???
* ?°???¨?????????é??????°???¨?ˇ?????????????????????°?????????é????????
**********************************************************/
void YS_SYN_Set(u8 *Info_data)
{
    u8 Com_Len;
    Com_Len = strlen((char*)Info_data);
    // USART3_SendString(Info_data, Com_Len);
    FtFreertosUartBlcokingSend(&uart,Info_data,Com_Len);     //???????????°????????¨??????
    FPl011Send(&uart.bsp_uart,Info_data,Com_Len);
}

