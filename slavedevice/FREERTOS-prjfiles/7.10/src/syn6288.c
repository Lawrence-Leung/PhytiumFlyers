#include "syn6288.h"
#include "uart.h"
#include "string.h"
#include "fpl011_os.h"

#define SYN_FRAME_INFO_SIZE 256 // combination = para + data

extern FtFreertosUart uart;
extern FtFreertosUartConfig uart_config;
//Music:：????????????：?????????0:?????????：?????????1~15???：????????????：??????
void syn6288UartInit(void)
{
    FtFreertosUartInit(&uart,&uart_config);
    f_printk("[SLAVE] syn6288 ready!!\r\n");

}

void syn6288Play(u8 *data)
{
    char combination[SYN_FRAME_INFO_SIZE];
    char para[12] = "[v1][m0][t5]";

    // ????????????
    size_t remaining_space = SYN_FRAME_INFO_SIZE - strlen(para) - 1; //????〜?，??????┐????(-1，????│??，?????????????)
    size_t data_length = strlen(data);
    // f_printk("[SYN6288]remaining_space:%d\r\n",remaining_space);
    
    // ?????????∴????，????∴
    if (data_length > remaining_space) {
        printf("[SYN6288]Error: Data too long\n");
        return;
    }
    else
    {
        sprintf(combination,"%s%s",para,data);
        SYN_FrameInfo(0,combination);               //??，???????0??????＼??＜????
    }
        
    f_printk("[SYN6288]syn6288 finished!!\r\n");
}


/*
void SYN_FrameInfo(u8 Music, u8 *HZdata)
Music:bgm
HZdata:data to play
Migrate from STM32,do not change
*/
void SYN_FrameInfo(u8 Music, u8 *HZdata)
{
    /****************：?????????：????????????**********************************/
    unsigned  char  Frame_Info[50];
    unsigned  char  HZ_Length;
    unsigned  char  ecc  = 0;  			//?????????：?????????
    unsigned  int i = 0;
    HZ_Length = strlen((char*)HZdata); 			//：?????????：????????????：??????

    /*****************???━??????：????????????**************************************/
    Frame_Info[0] = 0xFD ; 			//???：??????━??┬?FD
    Frame_Info[1] = 0x00 ; 			//???：?????????????：?????????：?????????
    Frame_Info[2] = HZ_Length + 3; 		//???：?????????????：??????????????????
    Frame_Info[3] = 0x01 ; 			//???：?????????┬????????????????????????
    Frame_Info[4] = 0x01 | Music << 4 ; //???：?????????┬????????????????：????????????

    /*******************???：????????????***************************************/
    for(i = 0; i < 5; i++)   				//?????????：??????：?????????5??????━??┬???????
    {
        ecc = ecc ^ (Frame_Info[i]);		//??????：???????????????????????????：???
    }

    for(i = 0; i < HZ_Length; i++)   		//?????????：????????????????????????????
    {
        ecc = ecc ^ (HZdata[i]); 				//??????：???????????????????????????：???
    }
    /*******************???：??????━??????***************************************/
    memcpy(&Frame_Info[5], HZdata, HZ_Length);
    Frame_Info[5 + HZ_Length] = ecc;
    //   USART3_SendString(Frame_Info, 5 + HZ_Length + 1);
    // f_printk("speaking......\r\n");
    FtFreertosUartBlcokingSend(&uart,Frame_Info,5+HZ_Length+1);     //??????????????????????′??????
    // FPl011Send(&uart.bsp_uart,Frame_Info,5 + HZ_Length + 1);
}


/***********************************************************
* ???    ??━????? YS_SYN_Set(u8 *Info_data)
* ???    ?????? ?????????	??′??????????
* ???????????????? *Info_data:?????????：???????????????：???
* ????????????????
* ???    ???????????????????′???：????????????????????????????????????????????? ???：??????┬?????????9600bps???
* ???????′?????????：?????????????′???????????????????????????????????：?????????
**********************************************************/
void YS_SYN_Set(u8 *Info_data)
{
    u8 Com_Len;
    Com_Len = strlen((char*)Info_data);
    // USART3_SendString(Info_data, Com_Len);
    FtFreertosUartBlcokingSend(&uart,Info_data,Com_Len);     //??????????????????????′??????
    FPl011Send(&uart.bsp_uart,Info_data,Com_Len);
}

